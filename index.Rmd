---
runtime: shiny
title: "WDI Dashboard"
author: "by âˆš3kT/m"
---

```{r setup, include=FALSE}
library(flexdashboard)
library(htmltools)
library(shiny)
library(shinydashboard)
library(shinycssloaders)
library(shinyWidgets)
library(leaflet)
library(WDI)
library(bslib)
library(plotly)
library(ggplot2)
library(data.table)
library(leaflet)
library(geojsonio)
library(rstudioapi)
```

```{r import-data}

#setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

source("apps/data/get-data.r", chdir=T)
source("apps/choose-country-list/choose-country-list.R", chdir=T)
source("apps/choose-country-map/choose-country-map.R", chdir=T)
source("apps/choose-indicator/choose-indicator.R", chdir=T)
source("apps/choose-date/choose-date.R", chdir=T)

```

```{r ploting}
  #function for linear plotting  
    line_plot <- function(selectData){
        plot <- ggplot() +
          geom_line(selectData, mapping = aes(year, value, colour = country)) +
          ylab("value") +
          theme_classic() +
          scale_fill_brewer(palette = "RdPu")+
          scale_y_log10()
        return(plot)}
  #function for area plotting  
    area_plot <- function(selectData){
        plot <- ggplot() +
          geom_area(selectData, mapping = aes(year, value, fill = country)) +
          ylab("value") +
          theme_classic() +
          scale_fill_brewer(palette = "YIGn")
        return(plot)}

```

Indicators Overview 
===================================== 
```{r Education Indicators Overview }

#education indicators
education.indicators.list <- c("SE.TER.CUAT.DO.ZS","SE.TER.CUAT.MS.ZS","SE.TER.CUAT.BA.ZS","SE.TER.CUAT.ST.ZS","SE.SEC.CUAT.UP.ZS","SE.SEC.CUAT.LO.ZS","SE.SEC.CUAT.PO.ZS","SE.PRM.CUAT.ZS")

#countries of interest 
countries.of.interest <- c("DEU", "FRA", "ITA", "GBR", "ESP", "UKR", "POL", "ROU", "NLD", "GRC", "BEL", "CZE", "PRT", "SWE", "HUN", "AUT", "SRB", "SVK", "SVN", "CHE", "BGR", "DNK", "FIN", "NOR", "IRL", "HRV", "MDA", "BIH", "ALB", "LTU", "MKD", "LVA", "EST", "MNE", "LUX", "MLT", "ISL", "AND", "MCO", "LIE", "SMR")

polygons.of.interest <- WB_CountryPolygons[WB_CountryPolygons$ISO_A3_EH %in% countries.of.interest,]
#data to plot on the map
map.data <- WDI(country = countries.of.interest, indicator = "SE.XPD.TOTL.GB.ZS", latest = 1)

country.data <- na.omit(melt(setDT(WDI(country = countries.of.interest, indicator = education.indicators.list, latest = 1)),id.vars = c("country","iso2c","iso3c","year"), variable.name = "indicator"))
country.data$indicator<-sapply(country.data$indicator, function(x){WDIsearch(x,field="indicator")$name})

min.expenditure <- floor(min(map.data$SE.XPD.TOTL.GB.ZS, na.rm = TRUE))
max.expenditure <- ceiling(max(map.data$SE.XPD.TOTL.GB.ZS, na.rm = TRUE))


polygons.of.interest$EDUC <- map.data[match(polygons.of.interest$ISO_A3_EH, map.data$iso3c), "SE.XPD.TOTL.GB.ZS"]
polygons.of.interest$EDUC.YEAR <- map.data[match(polygons.of.interest$ISO_A3_EH, map.data$iso3c), "year"]
polygons.of.interest <- polygons.of.interest[order(polygons.of.interest$EDUC, decreasing = TRUE),]

palette <- colorBin(palette = "Greens", domain = c(min.expenditure, max.expenditure), bins = seq(min.expenditure, max.expenditure, by = 0.01), na.color = "#f8f4f4")

shinyApp(
  ####
  #UI#
  ####
  ui=fluidPage(theme = bs_theme(version = 4, bootswatch = "minty"),
               tags$head(tags$style(
      HTML(
        "
    .leaflet-container {
    background-color:rgba(255,0,0,0.0);}
    "
        )
    )),
    sidebarLayout(
      sidebarPanel(
        fluidRow(
          ChooseCountryListUI("Vova_Country",WB_CountryPolygons[WB_CountryPolygons$ISO_A3_EH %in% countries.of.interest,]$NAME_EN)
        ),
        fluidRow(
          sliderInput("rangevalues",
  label = strong("Select Total Expenditure on Education (% of government spending):"),
  min = min.expenditure, max = max.expenditure,
  value = c(min.expenditure, max.expenditure/2), 
  step = 0.1,
  sep="",
  width = "100%"
  )
  ),
  hr(),
    fluidRow(
      helpText(
        "Select expenditure range to display on the map"
      )
    )
      ),
      mainPanel(
       fluidRow(column(
      width = 12,
      withSpinner(leafletOutput(
        outputId = "myMap", width = "100%"
      ), color = "#80c4ac")
    )),
    fluidRow(
      tableOutput("test")
    )
      )
    )
  ),
  ########
  #SERVER#
  ########
  server = function(input, output) {
    
    country <- ChooseCountryListServer("Vova_Country")
    groups <- reactiveValues(count = 0)
    
    foundational.map <- reactive({
      leaflet() %>%
        addPolygons(
          data = polygons.of.interest,
          layerId = polygons.of.interest$NAME_EN,
          group = "base",
          fill = TRUE,
          fillColor = palette(polygons.of.interest$EDUC), 
          fillOpacity = 1,
          weight = 1,
          color = "#80c4ac",
          label = paste0(
            "<strong>Country: </strong>",
            polygons.of.interest$NAME_EN,
            "<br/> ",
            "<strong>Year: </strong>",
            polygons.of.interest$EDUC.YEAR,
            "<br/>",
            "<strong>Total exp.(%): </strong>",
            round(polygons.of.interest$EDUC, 2),
            "<br/> "
          ) %>% lapply(htmltools::HTML),
          labelOptions = labelOptions(noHide = FALSE)
        ) %>% setView(lng = 16.1657
                      ,
                      lat = 50.4515
                      ,
                      zoom = 3) %>%
        setMaxBounds(
          lng1 = 16.1657
          ,
          lat1 = 50.4515
          ,
          lng2 = 16.1657
          ,
          lat2 = 50.4515
        )%>%
   addLegend(
      colors= palette(polygons.of.interest$EDUC), labels = paste0(
            polygons.of.interest$NAME_EN,
            " - ",
            round(polygons.of.interest$EDUC, 2), " %"
          ),
      opacity = 1, title = "Total exp.(%)"
    )
    })
    
    observeEvent(input$rangevalues, {
      groups$count = groups$count + 1
      
      lines.of.interest <-
        polygons.of.interest[which(
          !is.na(polygons.of.interest$EDUC) &
            polygons.of.interest$EDUC <= input$rangevalues[1] |
            polygons.of.interest$EDUC >= input$rangevalues[2]
        ), ]
      
      leafletProxy(mapId = "myMap") %>%
        addPolygons(
          data = lines.of.interest,
          layerId = lines.of.interest@data$id,
          group = as.character(groups$count),
          fill = TRUE,
          fillColor = "#f8f4f4",
          fillOpacity = 1,
          weight = 1,
          color = "#5a5a5a",
          highlightOptions = highlightOptions(
            weight = 4,
            color = "#80c4ac",
            bringToFront = F
          ),
          label = paste0(
            "Country: ",
            lines.of.interest$NAME_EN,
            "<br/> ",
            "Year: ",
            lines.of.interest$EDUC.YEAR,
            "<br/>",
            "Total exp.(%): ",
            round(lines.of.interest$EDUC, 2),
            "<br/> "
          ) %>% lapply(htmltools::HTML),
          labelOptions = labelOptions(noHide = FALSE)
        ) %>% clearGroup(as.character(groups$count - 1))
    }, ignoreNULL = FALSE)
    
    observeEvent(country(),{
      
      plot.data <- country.data[country.data$iso3c == country(),]
      output$test <- renderTable({plot.data})
      
    }, ignoreNULL = FALSE)
    
    output$myMap <- renderLeaflet({
      foundational.map()
    })
    
  }
)

```

Countries Overview 
=====================================  

```{r, warning=FALSE}
shinyApp(
  ####
  #UI#
  ####
  ui = fluidPage(
    theme = bs_theme(version = 4, bootswatch = "minty"),
    sidebarLayout(
      sidebarPanel(
        actionButton("update","Update View", icon("refresh"), width = "100%"),
        hr(),
        ChooseCountryMapUI("1"),
        ChooseIndicatorListUI("2"),
        ChooseDateUI("3")
        
      ),
      mainPanel(tabsetPanel(
        type = "tabs",
        tabPanel("Custom",
                 div(
                   helpText(
                     "Select,what type of plot would you like to see. You can also find some data if you select area out of the plot in 'rectangle'"),
                   hr(),
                   radioGroupButtons(
                     inputId = "change_plot",
                     choices = c(
                       `<i class='fa fa-line-chart'></i>` = "line",
                       `<i class='fa fa-area-chart''></i>` = "area"),
                     justified = TRUE,
                     selected = "line")),
                 withSpinner(
                 plotOutput("firstPlot",
                            width = "100%",
                            height = "300px",
                            brush = "plot_brush"),
                 color = "#80c4ac"),
                 tableOutput("data")
                 ),
                
        tabPanel(
          "Overview",
          br(),
          fluidRow(
             column(6,
                    withSpinner(
                    plotlyOutput(outputId = "plot1", width = "500px", height = "200px"), color = "#80c4ac")),
             column(6,
                    withSpinner(
               plotlyOutput(outputId ="plot2", width = "500px", height = "200px"),color = "#80c4ac"))
             ),
          fluidRow(
             column(6,
                    withSpinner(
                    plotlyOutput(outputId = "plot3", width = "500px", height = "200px"), color = "#80c4ac")),
             column(6,
                    withSpinner(
               plotlyOutput(outputId ="plot4", width = "500px", height = "200px"),color = "#80c4ac"))
             ),
          fluidRow(
             column(6,
                    withSpinner(
                    plotlyOutput(outputId = "plot5", width = "500px", height = "200px"), color = "#80c4ac")),
             column(6,
                    withSpinner(
               plotlyOutput(outputId ="plot6", width = "500px", height = "200px"),color = "#80c4ac"))
             ),
          fluidRow(textOutput(outputId ="text"))
          )
             
          )
        )
      )
      
    ),
  ########
  #SERVER#
  ########
  server = function(input, output) {
    
    country.list <- ChooseCountryMapServer("1")
    indicator.list <- ChooseIndicatorListServer("2")
    date.list <- ChooseDateServer("3")
      
    
    selectData <- eventReactive(input$update,{
      
      req(country.list(),indicator.list(),date.list(),cancelOutput = TRUE)
        
      return(melt(setDT(WDI(
        country = country.list(),
        indicator = indicator.list(),
        start = date.list()[1],
        end = date.list()[2]
      )),id.vars = c("country","iso2c","iso3c","year"),
                     variable.name = "indicator"))
      
      },ignoreNULL = FALSE)

    
###Page1###
    
    output$firstPlot <- renderPlot({
      
      if (input$change_plot %in% "line") {
        line_plot(selectData())
      } else {
        area_plot(selectData())
      }
    })
    
###SecondPage###
    #1#
    
    n <- reactive({length(unique(selectData()$indicator))})
    
    #2# 
    plot1 <- reactive({
      if (n()>=1){line_plot(selectData()[selectData()$indicator == unique(selectData()$indicator)[1],])}
      else
      {return(NULL)}
     })
    
    #2# 
    plot2 <- reactive({
      if (n()>=2){line_plot(selectData()[selectData()$indicator == unique(selectData()$indicator)[2],])}
      else
      {return(NULL)}
     })
    
    #3# 
    plot3 <- reactive({
      if (n()>=3){line_plot(selectData()[selectData()$indicator == unique(selectData()$indicator)[3],])}
      else
      {return(NULL)}
     })
    
    #4# 
    plot4 <- reactive({
      if (n()>=4){line_plot(selectData()[selectData()$indicator == unique(selectData()$indicator)[4],])}
      else
      {return(NULL)}
     })
    
    #5# 
    plot5 <- reactive({
      if (n()>=5){line_plot(selectData()[selectData()$indicator == unique(selectData()$indicator)[5],])}
      else
      {return(NULL)}
     })
    
    #6# 
    plot6 <- reactive({
      if (n()==6){line_plot(selectData()[selectData()$indicator == unique(selectData()$indicator)[6],])}
      else
      {return(NULL)}
     })

    output$plot1 = renderPlotly({plot1()}) 
    output$plot2 = renderPlotly({plot2()}) 
    output$plot3 = renderPlotly({plot3()}) 
    output$plot4 = renderPlotly({plot4()}) 
    output$plot5 = renderPlotly({plot5()}) 
    output$plot6 = renderPlotly({plot6()}) 

          
     #4#
      output$data <- renderTable({
        plotdata<-selectData()
        brushedPoints(plotdata, input$plot_brush)
      })
      test <- reactive({
                   WDI_Indicators[WDI_Indicators$Indicator.Name %in% input$searchIndicator, 1]
                 })
      output$text <- renderText((test()))
  }
)
```

Architecture {data-navmenu="Making"}
=====================================  


Widgets {data-navmenu="Making"}
=====================================  


Team
=====================================     
